<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventMaster - Gestion d'Événements</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f6f9; }
        .navbar { box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .event-img { height: 180px; object-fit: cover; border-top-left-radius: 12px; border-top-right-radius: 12px; background-color: #ddd; }
        .sidebar { min-height: 100vh; background: #fff; padding-top: 20px; }
        .status-badge { font-size: 0.75em; padding: 5px 10px; border-radius: 20px; }
        /* Loader */
        .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    </style>
</head>
<body>

    <div id="loader" class="spinner-overlay d-none">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Chargement...</span>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="#"><i class="fa-solid fa-calendar-check me-2"></i>EventMaster</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" href="#" onclick="showView('events')">Événements</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showView('admin')">Administration</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <div id="guest-nav">
                        <button onclick="showLoginModal()" class="btn btn-outline-primary btn-sm me-2">Connexion</button>
                        <button onclick="showRegisterModal()" class="btn btn-primary btn-sm">Inscription</button>
                    </div>
                    <div id="user-nav" class="d-none dropdown">
                        <a class="nav-link dropdown-toggle text-dark fw-bold" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fa-solid fa-user-circle me-1"></i> <span id="username-display">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">Mes Réservations</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Déconnexion</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        
        <div id="view-events">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fa-solid fa-ticket me-2 text-warning"></i>Événements à venir</h3>
                <div class="input-group w-25">
                    <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" placeholder="Rechercher...">
                </div>
            </div>
            
            <div class="row g-4" id="events-container">
                </div>
        </div>

        <div id="view-admin" class="d-none">
            <div class="row">
                <div class="col-12 mb-4">
                    <h3>Tableau de bord Administrateur</h3>
                    <p class="text-muted">Gestion des microservices et des données.</p>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white p-3">
                        <h3>124</h3>
                        <small>Utilisateurs (Laravel)</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white p-3">
                        <h3>8</h3>
                        <small>Événements (Symfony)</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark p-3">
                        <h3>$4,250</h3>
                        <small>Revenus (PHP Native)</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white p-3">
                        <h3>98%</h3>
                        <small>Emails Délivrés (PHP Native)</small>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header bg-white fw-bold">Ajouter un événement (Microservice Symfony)</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>Nom de l'événement</label>
                            <input type="text" id="admin-evt-name" class="form-control" placeholder="Ex: Tech Conference 2025">
                        </div>
                        <div class="col-md-4">
                            <label>Date</label>
                            <input type="date" id="admin-evt-date" class="form-control">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button onclick="createEvent()" class="btn btn-success w-100"><i class="fa-solid fa-plus"></i> Créer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Connexion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" id="login-email" class="form-control" value="ali@test.com">
                    </div>
                    <div class="mb-3">
                        <label>Mot de passe</label>
                        <input type="password" id="login-pass" class="form-control" value="password">
                    </div>
                    <button onclick="performLogin()" class="btn btn-primary w-100">Se connecter</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // --- CONFIGURATION ---
        const API_URL = 'http://localhost:8081/api'; // URL de l'API Gateway
        let USER_TOKEN = null;
        let USER_EMAIL = null;

        // --- NAVIGATION ---
        function showView(viewName) {
            document.getElementById('view-events').classList.add('d-none');
            document.getElementById('view-admin').classList.add('d-none');
            document.getElementById(`view-${viewName}`).classList.remove('d-none');
            
            // Active link styling
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showLoginModal() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
        
        function toggleLoader(show) {
            const loader = document.getElementById('loader');
            if(show) loader.classList.remove('d-none');
            else loader.classList.add('d-none');
        }

        // --- AUTHENTIFICATION (Service Laravel) ---
        async function performLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            
            // Fermer la modal
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            toggleLoader(true);

            try {
                const res = await fetch(`${API_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                toggleLoader(false);

                if (res.ok) {
                    const data = await res.json();
                    USER_TOKEN = data.token;
                    USER_EMAIL = email;
                    updateUIForLoggedUser(email);
                    Swal.fire({ icon: 'success', title: 'Bienvenue !', text: 'Connexion au service Laravel réussie.', timer: 2000, showConfirmButton: false });
                } else {
                    Swal.fire({ icon: 'error', title: 'Erreur', text: 'Identifiants incorrects (Service Laravel)' });
                }
            } catch (e) {
                toggleLoader(false);
                console.error(e);
                // Mock pour la démo si l'API est éteinte
                Swal.fire({ icon: 'warning', title: 'Mode Démo', text: 'API injoignable, connexion simulée.' });
                updateUIForLoggedUser(email);
            }
        }

        function updateUIForLoggedUser(email) {
            document.getElementById('guest-nav').classList.add('d-none');
            document.getElementById('user-nav').classList.remove('d-none');
            document.getElementById('username-display').innerText = email.split('@')[0];
        }

        function logout() {
            USER_TOKEN = null;
            document.getElementById('guest-nav').classList.remove('d-none');
            document.getElementById('user-nav').classList.add('d-none');
            Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Déconnecté', showConfirmButton: false, timer: 1500 });
        }

        // --- ÉVÉNEMENTS (Service Symfony) ---
        async function loadEvents() {
            toggleLoader(true);
            try {
                const res = await fetch(`${API_URL}/events`);
                let events = [];
                if(res.ok) events = await res.json();
                
                // Si vide (ou erreur), on met des fausses données pour la démo visuelle
                if(events.length === 0) {
                    events = [
                        { id: 1, name: 'Concert Coldplay', date: '2024-06-15', img: 'https://images.unsplash.com/photo-1459749411177-734a649eae5b?auto=format&fit=crop&w=800&q=80' },
                        { id: 2, name: 'Tech Summit 2024', date: '2024-09-10', img: 'https://images.unsplash.com/photo-1505373877841-8d25f7d46678?auto=format&fit=crop&w=800&q=80' },
                        { id: 3, name: 'Atelier Cuisine', date: '2024-05-20', img: 'https://images.unsplash.com/photo-1556910103-1c02745a30bf?auto=format&fit=crop&w=800&q=80' }
                    ];
                }

                const container = document.getElementById('events-container');
                container.innerHTML = '';
                
                events.forEach(evt => {
                    // Image aléatoire si non fournie
                    const img = evt.img || 'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?auto=format&fit=crop&w=800&q=80';
                    
                    container.innerHTML += `
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="event-img" style="background-image: url('${img}'); background-size: cover; background-position: center;"></div>
                                <div class="card-body">
                                    <h5 class="card-title fw-bold">${evt.name}</h5>
                                    <p class="card-text text-muted"><i class="fa-regular fa-calendar me-2"></i>${evt.date}</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="h5 text-primary mb-0">45 €</span>
                                        <button onclick="bookEvent(${evt.id}, '${evt.name}')" class="btn btn-sm btn-dark">Réserver</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

            } catch (e) { console.error(e); }
            toggleLoader(false);
        }

        async function createEvent() {
            const name = document.getElementById('admin-evt-name').value;
            const date = document.getElementById('admin-evt-date').value;
            
            if(!name || !date) return Swal.fire('Erreur', 'Remplissez tous les champs', 'warning');

            try {
                await fetch(`${API_URL}/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, date })
                });
                Swal.fire('Succès', 'Événement créé dans Symfony', 'success');
                document.getElementById('admin-evt-name').value = '';
                loadEvents(); // Recharger la liste
            } catch(e) {
                Swal.fire('Erreur', 'Service Symfony indisponible', 'error');
            }
        }

        // --- RÉSERVATION & NOTIFICATION (PHP Native) ---
        async function bookEvent(eventId, eventName) {
            if (!USER_EMAIL) {
                return Swal.fire('Attention', 'Veuillez vous connecter pour réserver.', 'info');
            }

            const { value: confirm } = await Swal.fire({
                title: 'Confirmer la réservation',
                text: `Voulez-vous acheter un billet pour "${eventName}" ?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Payer (Stripe)',
                cancelButtonText: 'Annuler'
            });

            if (confirm) {
                toggleLoader(true);
                
                // 1. Appel Service Réservation
                try {
                    const resResa = await fetch(`${API_URL}/reservations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event_id: eventId, user_id: 123 }) // User ID simulé
                    });
                    const dataResa = await resResa.json();

                    // 2. Si succès, Appel Service Notification
                    if (resResa.ok || dataResa.status === 'CONFIRMED') {
                        await fetch(`${API_URL}/notifications`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: USER_EMAIL, message: `Billet confirmé pour ${eventName}` })
                        });

                        toggleLoader(false);
                        Swal.fire({
                            icon: 'success',
                            title: 'Réservation Réussie !',
                            html: `Paiement validé.<br>Email de confirmation envoyé à <b>${USER_EMAIL}</b>.<br><small class='text-muted'>Transaction: ${dataResa.transaction_id || 'N/A'}</small>`
                        });
                    } else {
                        throw new Error("Echec paiement");
                    }
                } catch (e) {
                    toggleLoader(false);
                    // Fallback pour la démo si les services PHP ne répondent pas (ex: pas démarrés)
                    Swal.fire({
                        icon: 'success',
                        title: 'Réservation Simulée',
                        text: `Les services semblent éteints, mais dans une prod réelle, le paiement Stripe serait passé et l'email envoyé à ${USER_EMAIL}.`
                    });
                }
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
        });

    </script>
</body>
</html>
# Fichier: docker-compose.jenkins.yml (CORRIGÉ & COMPLET)
version: '3.8'

services:
  # 1. Service Laravel
  user_service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user_service_test_app
    networks:
      - events_network
    environment:
      - APP_KEY=base64:IgYfA8Xz1lUUQPItd/y/G9J0A9m9fP9hK/T2h/u3N8Y=
      - DB_CONNECTION=mysql
      - DB_HOST=db_mysql
      - DB_DATABASE=db_events_main
      - DB_USERNAME=root
      - DB_PASSWORD=root_password
      - CACHE_DRIVER=array
      - SESSION_DRIVER=array

  # 2. Service Symfony
  event_service:
    build:
      context: ./services/event-service
      dockerfile: Dockerfile
    container_name: event_service_test_app
    networks:
      - events_network
    environment:
      - DATABASE_URL=mysql://root:root_password@db_mysql:3306/db_events?serverVersion=8.0

  # 3. Service Réservation
  reservation_service:
    build:
      context: ./services/reservation-service
      dockerfile: Dockerfile
    container_name: reservation_service_test_app
    networks:
      - events_network

  # 4. Service Notification
  notification_service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: notification_service_test_app
    networks:
      - events_network

  # 5. API Gateway (CORRIGÉ : Bien aligné sous services)
  api_gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: api_gateway_test
    ports:
      - "8081:80"
    depends_on:
      - user_service
      - event_service
      - reservation_service
      - notification_service
    networks:
      - events_network

  # 6. Frontend (CORRIGÉ : Bien aligné sous services)
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    container_name: frontend_test
    networks:
      - events_network

# Le bloc networks doit être TOUT EN BAS, complètement à gauche
networks:
  events_network:
    external: true
    name: projet-gestion-evenements_events_network